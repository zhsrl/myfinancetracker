<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Fin</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="/assets/favicon.ico">
    <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <style>
        /* Стили для кастомной прокрутки */
        .slider-container::-webkit-scrollbar {
            height: 4px;
        }
        .slider-container::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 2px;
        }
        .dark .slider-container::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.2);
        }
        
        .slider-item {
            flex: 0 0 280px; /* Фиксированная ширина карточки */
            scroll-snap-align: start;
        }
        
        @media (min-width: 640px) {
            .slider-item {
                flex: 0 0 320px; /* Чуть шире на sm экранах */
            }
        }
        
        /* Плавное появление */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Кастомный Toast (уведомление) */
        #toast-notification {
            transition: all 0.5s ease;
            transform: translateY(100%);
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Стили для выбора логотипа банка */
        .bank-logo {
            width: 70px;
            height: 50px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: white;
            padding: 4px;
        }
        .bank-logo.selected {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .bank-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* Fallback стиль, если лого не загрузится */
        .bank-logo.logo-fallback {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4b5563; /* gray-600 */
            background-color: #f3f4f6; /* gray-100 */
        }
        .logo-fallback {
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151; /* gray-700 */
        }

        /* Стили для выбора цвета */
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .color-swatch.selected {
            border-color: #3b82f6; /* blue-500 */
            transform: scale(1.1);
        }
        
        /* Cтили для Drag-n-Drop */
        .slider-item.dragging {
            opacity: 0.5;
            border: 2px dashed #3b82f6;
        }
    </style>
    <script>
        // Управление темной темой (АВТОМАТИЧЕСКОЕ)
        const applyTheme = () => {
            // Удаляем старые классы на всякий случай
            document.documentElement.classList.remove('dark', 'light');
            
            // Проверяем localStorage ИЛИ системные настройки
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                // localStorage.theme === 'light' ИЛИ нет 'theme' и система светлая
                document.documentElement.classList.add('light');
            }
        };

        // Применяем тему сразу при загрузке
        applyTheme();
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen font-sans">

    <!-- 
      НОВЫЙ БЛОК: ЭКРАН АВТОРИЗАЦИИ
      (Показывается по умолчанию, скрывается после входа)
    -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-6">MyFin</h2>
            
            <!-- Табы Вход/Регистрация -->
            <div class="flex mb-6 border-b border-gray-200 dark:border-gray-700">
                <button id="auth-tab-login" class="flex-1 py-3 font-semibold text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400" data-lang-key="auth.login">
                    Вход
                </button>
                <button id="auth-tab-register" class="flex-1 py-3 font-semibold text-gray-500 dark:text-gray-400" data-lang-key="auth.register">
                    Регистрация
                </button>
            </div>

            <!-- Форма Входа -->
            <form id="auth-form-login">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="auth.email">Email</label>
                    <input type="email" id="login-email" placeholder="email@example.com" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="auth.password">Пароль</label>
                    <input type="password" id="login-password" placeholder="••••••••" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all" data-lang-key="auth.loginButton">
                    Войти
                </button>
            </form>

            <!-- Форма Регистрации (скрыта) -->
            <form id="auth-form-register" class="hidden">
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="auth.email">Email</label>
                    <input type="email" id="register-email" placeholder="email@example.com" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="auth.password">Пароль</label>
                    <input type="password" id="register-password" placeholder="••••••••" data-lang-key-placeholder="auth.passwordPlaceholder" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all" data-lang-key="auth.registerButton">
                    Создать аккаунт
                </button>
            </form>
            
            <p id="auth-error" class="text-center text-red-500 text-sm mt-4"></p>
        </div>
    </div>


    <!-- 
      ОСНОВНОЕ ПРИЛОЖЕНИЕ
      (Скрыто по умолчанию, показывается после входа)
    -->
    <div id="main-app" class="hidden">

        <!-- 
          МОДАЛЬНЫЕ ОКНА (изначально скрыты)
        -->

        <!-- 1. Модальное окно: Новая транзакция -->
        <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-end sm:items-center p-4 z-50 hidden fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
                <button id="close-transaction-modal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <h3 id="transaction-modal-title" class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Новая транзакция</h3>
                
                <form id="transaction-form">
                    <!-- Описание -->
                    <div class="mb-4">
                        <label for="transaction-description" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.description">Описание</label>
                        <input type="text" id="transaction-description" placeholder="Напр., Покупка в Magnum" data-lang-key-placeholder="forms.descriptionPlaceholder" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    
                    <!-- Сумма -->
                    <div class="mb-4">
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.amount">Сумма (₸)</label>
                        <input type="number" id="transaction-amount" placeholder="0" step="0.01" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    
                    <!-- Выбор счета (Откуда) -->
                    <div class="mb-4">
                        <label for="transaction-account" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.account">Счет</label>
                        <select id="transaction-account" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none" required>
                            <!-- Опции для счетов будут добавлены JS -->
                        </select>
                    </div>

                    <!-- Категория (ДИНАМИЧЕСКАЯ) -->
                    <div id="category-container" class="mb-4">
                        <label for="transaction-category" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.category">Категория</label>
                        <select id="transaction-category" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none">
                            <!-- Опции для категорий будут добавлены JS -->
                        </select>
                    </div>

                    <!-- Выбор кредита (для оплаты) -->
                    <div id="loan-payment-container" class="mb-4 hidden">
                        <label for="transaction-loan-select" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.whichLoan">Какой кредит оплачиваете?</label>
                        <select id="transaction-loan-select" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none">
                            <!-- Опции для кредитов будут добавлены JS -->
                        </select>
                    </div>
                    
                    <!-- Выбор счета для сбережений (Перевод) -->
                    <div id="savings-transfer-container" class="mb-4 hidden">
                        <label for="transaction-savings-select" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.whichSavingsAccount">На какой сберегательный счет?</label>
                        <select id="transaction-savings-select" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none">
                            <!-- Опции для сбережений будут добавлены JS -->
                        </select>
                    </div>

                    <input type="hidden" id="transaction-type">
                    
                    <button type="submit" id="submit-transaction-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-all">
                        Добавить
                    </button>
                </form>
            </div>
        </div>

        <!-- 2. Модальное окно: Новый счет -->
        <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-end sm:items-center p-4 z-50 hidden fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-lg p-6 relative overflow-y-auto max-h-[90vh]">
                <button id="close-account-modal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <h3 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6" data-lang-key="forms.newAccountTitle">Новый счет</h3>
                
                <form id="account-form">
                    <!-- Тип счета -->
                    <div class="mb-4">
                        <label for="account-type" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.accountType">Тип счета</label>
                        <select id="account-type" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none">
                            <option value="bank" data-lang-key="accountTypes.bank">Банк</option>
                            <option value="deposit" data-lang-key="accountTypes.deposit">Депозит</option>
                            <option value="savings" data-lang-key="accountTypes.savings">Сбережение</option>
                            <option value="cash" data-lang-key="accountTypes.cash">Наличный</option>
                        </select>
                    </div>

                    <!-- Выбор банка (появляется если тип "Банк") -->
                    <div id="bank-logo-container" class="mb-4">
                         <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.selectBank">Выберите банк</label>
                         <div class="grid grid-cols-3 gap-3 justify-center">
                            <div class="bank-logo" data-bank-name="Kaspi Bank" data-bank-logo-url="https://kaspi.kz/img/Logo.svg">
                                <img src="https://kaspi.kz/img/Logo.svg" alt="Kaspi Bank" onerror="this.parentElement.innerHTML = 'K'; this.parentElement.classList.add('logo-fallback');">
                            </div>
                             <div class="bank-logo" data-bank-name="Freedom Bank" data-bank-logo-url="https://bankffin.kz/images/invest-card-promo/briefcase-icons/bankffin.svg">
                                <img src="https://bankffin.kz/images/invest-card-promo/briefcase-icons/bankffin.svg" alt="Freedom Bank" onerror="this.parentElement.innerHTML = 'K'; this.parentElement.classList.add('logo-fallback');">
                            </div>
                            <div class="bank-logo" data-bank-name="Halyk Bank" data-bank-logo-url="https://halykbank.kz/storage/app/uploads/public/652/cf7/01b/652cf701be5b8939869157.svg">
                                <img src="https://halykbank.kz/storage/app/uploads/public/652/cf7/01b/652cf701be5b8939869157.svg" alt="Halyk Bank" onerror="this.parentElement.innerHTML = 'H'; this.parentElement.classList.add('logo-fallback');">
                            </div>
                            <div class="bank-logo" data-bank-name="ForteBank" data-bank-logo-url="https://forte.kz/_next/image?url=https%3A%2F%2Fmain.storage-object.pscloud.io%2FFrame_2087330514_20281c4df7.svg&w=768&q=85">
                                 <img src="https://forte.kz/_next/image?url=https%3A%2F%2Fmain.storage-object.pscloud.io%2FFrame_2087330514_20281c4df7.svg&w=768&q=85" alt="ForteBank" onerror="this.parentElement.innerHTML = 'F'; this.parentElement.classList.add('logo-fallback');">
                            </div>
                            <div class="bank-logo" data-bank-name="CenterCredit" data-bank-logo-url="https://www.bcc.kz/themes/bcc/assets/images/logo.svg">
                                <img src="https://www.bcc.kz/themes/bcc/assets/images/logo.svg" alt="CenterCredit" onerror="this.parentElement.innerHTML = 'B'; this.parentElement.classList.add('logo-fallback');">
                            </div>
                         </div>
                         <input type="hidden" id="account-logo-url">
                    </div>

                    <!-- Название счета -->
                    <div class="mb-4">
                        <label for="account-name" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.accountName">Название</label>
                        <input type="text" id="account-name" placeholder="Напр., Kaspi Bank" data-lang-key-placeholder="forms.accountNamePlaceholder" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>

                    <!-- Начальный баланс -->
                    <div class="mb-4">
                        <label for="account-balance" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.currentBalance">Текущий баланс (₸)</label>
                        <input type="number" id="account-balance" placeholder="0" step="0.01" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    
                    <!-- Выбор цвета -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.cardColor">Цвет карты</label>
                        <div id="color-picker" class="flex flex-wrap gap-3 justify-center">
                            <div class="color-swatch selected" data-color="from-blue-500 to-blue-700" style="background: linear-gradient(to right, #3b82f6, #1d4ed8);"></div>
                            <div class="color-swatch" data-color="from-green-500 to-green-700" style="background: linear-gradient(to right, #22c55e, #15803d);"></div>
                            <div class="color-swatch" data-color="from-purple-500 to-purple-700" style="background: linear-gradient(to right, #a855f7, #7e22ce);"></div>
                            <div class="color-swatch" data-color="from-red-500 to-red-700" style="background: linear-gradient(to right, #ef4444, #b91c1c);"></div>
                            <div class="color-swatch" data-color="from-yellow-500 to-yellow-700" style="background: linear-gradient(to right, #eab308, #a16207);"></div>
                            <div class="color-swatch" data-color="from-cyan-500 to-cyan-700" style="background: linear-gradient(to right, #06b6d4, #0e7490);"></div>
                            <div class="color-swatch" data-color="from-pink-500 to-pink-700" style="background: linear-gradient(to right, #ec4899, #be185d);"></div>
                            <div class="color-swatch" data-color="from-indigo-500 to-indigo-700" style="background: linear-gradient(to right, #6366f1, #4338ca);"></div>
                            <div class="color-swatch" data-color="from-gray-700 to-gray-900" style="background: linear-gradient(to right, #374151, #111827);"></div>
                            <div class="color-swatch" data-color="from-orange-500 to-orange-700" style="background: linear-gradient(to right, #f97316, #c2410c);"></div>
                        </div>
                        <input type="hidden" id="account-color" value="from-blue-500 to-blue-700">
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all" data-lang-key="forms.addAccountButton">
                        Добавить счет
                    </button>
                </form>
            </div>
        </div>

        <!-- 3. Модальное окно: Новый кредит -->
        <div id="loan-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex justify-center items-end sm:items-center p-4 z-50 hidden fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
                <button id="close-loan-modal" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                    <i class="fas fa-times fa-lg"></i>
                </button>
                <h3 class="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6" data-lang-key="forms.newLoanTitle">Новый кредит</h3>
                
                <form id="loan-form">
                    <!-- Название -->
                    <div class="mb-4">
                        <label for="loan-name" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.loanName">Название</label>
                        <input type="text" id="loan-name" placeholder="Напр., Автокредит" data-lang-key-placeholder="forms.loanNamePlaceholder" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    <!-- Общая сумма -->
                    <div class="mb-4">
                        <label for="loan-total-amount" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.loanTotalAmount">Общая сумма (₸)</label>
                        <input type="number" id="loan-total-amount" placeholder="5000000" step="any" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    <!-- Уже оплачено -->
                    <div class="mb-4">
                        <label for="loan-paid-amount" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.loanPaidAmount">Уже оплачено (₸)</label>
                        <input type="number" id="loan-paid-amount" placeholder="0" step="any" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    <!-- Ежемесячный платеж -->
                    <div class="mb-4">
                        <label for="loan-monthly-payment" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.loanMonthlyPayment">Ежемесячный платеж (₸)</label>
                        <input type="number" id="loan-monthly-payment" placeholder="50000" step="any" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    <!-- Дата платежа -->
                    <div class="mb-4">
                        <label for="loan-payment-date" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="forms.loanPaymentDate">Число ежемесячного платежа</label>
                        <input type="number" id="loan-payment-date" placeholder="15" min="1" max="31" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white" required>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all" data-lang-key="forms.addLoanButton">
                        Добавить кредит
                    </button>
                </form>
            </div>
        </div>

        <!-- 4. Модальное окно: Вся история -->
        <div id="history-modal" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 hidden overflow-y-auto fade-in">
            <div class="w-full max-w-4xl mx-auto p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white" data-lang-key="history.allTitle">Вся история</h2>
                    <button id="close-history-modal" class="text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                        <i class="fas fa-times fa-2x"></i>
                    </button>
                </div>
                <div id="all-history-content" class="space-y-6">
                    <!-- Контент будет добавлен JS -->
                </div>
            </div>
        </div>


        <!-- 
          Боковая панель (Drawer)
        -->
        <div id="drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden transition-opacity duration-300"></div>
        <div id="drawer-content" class="fixed top-0 left-0 h-full w-80 max-w-[80%] bg-white dark:bg-gray-800 shadow-2xl z-40 transform -translate-x-full transition-transform duration-300 p-6 overflow-y-auto flex flex-col">
            <div class="flex-grow">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6" data-lang-key="settings.title">Настройки</h2>
            
                <!-- Блок Модели бюджета -->
                <div>
                    <label for="budget-model-select" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="settings.budgetModel">Модель Управления</label>
                    <select id="budget-model-select" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white appearance-none">
                        <option value="none" data-lang-key="settings.modelNone">Не выбрана</option>
                        <option value="50-30-20">50 / 30 / 20</option>
                        <option value="80-20">80 / 20 (Накопление)</option>
                    </select>
                    
                    <div id="model-display" class="mt-6 space-y-3">
                        <p class="text-gray-500 dark:text-gray-400" data-lang-key="settings.modelSelectPrompt">Выберите модель, чтобы увидеть распределение.</p>
                    </div>
                </div>
                
                <hr class="my-6 dark:border-gray-600">

                <!-- Блок Языка -->
                <div>
                    <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2" data-lang-key="settings.language">Язык</label>
                    <div class="flex gap-2">
                        <button id="lang-ru" class="lang-switcher flex-1 p-2 rounded-lg data-[active=true]:bg-blue-600 data-[active=true]:text-white bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Русский</button>
                        <button id="lang-kk" class="lang-switcher flex-1 p-2 rounded-lg data-[active=true]:bg-blue-600 data-[active=true]:text-white bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Қазақша</button>
                    </div>
                </div>
                
                <hr class="my-6 dark:border-gray-600">
                
                <div class="text-left text-xs text-gray-400">
                    <span data-lang-key="settings.loggedInAs">Вы вошли как:</span> <br> <strong id="user-email-display" class="font-mono text-sm break-words">...</strong>
                </div>
            </div>
            
            <!-- Кнопка Выхода -->
            <div class="mt-6">
                <button id="logout-button" class="w-full flex items-center justify-center gap-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 p-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-semibold" data-lang-key="settings.logout">Выйти</span>
                </button>
            </div>
        </div>


        <!-- 
          Основной контент страницы
        -->
        <div class="w-full max-w-4xl mx-auto p-4 sm:p-6">
            
            <!-- Шапка -->
            <header class="flex justify-between items-center mb-6">
                <button id="menu-toggle" class="text-gray-700 dark:text-gray-300 text-2xl p-2 -ml-2">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">MyFin</h1>
                <div class="w-8"></div> <!-- Заглушка для баланса -->
            </header>

            <!-- Адаптивная сетка -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Левая колонка (Балансы и Слайдеры) -->
                <div class="space-y-6">
                    
                    <!-- Балансы -->
                    <div class="grid grid-cols-1 gap-4"> <!-- ИЗМЕНЕНО: grid-cols-1 -->
                        <!-- Общий Баланс -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md text-center">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="dashboard.totalBalance">Общий баланс</span>
                            <p id="total-balance" class="text-3xl font-bold text-gray-900 dark:text-white truncate">0 ₸</p> <!-- ИЗМЕНЕНО: text-3xl -->
                        </div>
                        <!-- Сбережения (УДАЛЕНО ОТСЮДА) -->
                    </div>

                    <!-- Модель бюджета на главном -->
                    <div id="main-model-display" class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md">
                         <p class="text-center text-gray-500 dark:text-gray-400" data-lang-key="settings.modelSelectPromptShort">Выберите модель бюджета в настройках</p>
                    </div>

                    <!-- НОВЫЙ БЛОК: Сбережения и Долг -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Сбережения (ПЕРЕМЕЩЕНО) -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md text-center">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="dashboard.savings">Сбережения</span>
                            <p id="savings-balance" class="text-2xl font-bold text-green-600 dark:text-green-500 truncate">0 ₸</p>
                        </div>
                        <!-- Общий Долг (ПЕРЕМЕЩЕНО) -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md text-center">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="loans.totalDebt">Общий долг</span>
                            <p id="total-loan-balance" class="text-2xl font-bold text-red-600 dark:text-red-500 truncate">0 ₸</p>
                        </div>
                    </div>
                    
                    <!-- КНОПКИ Доход/Расход -->
                    <div class="grid grid-cols-2 gap-4">
                        <button id="nav-income" class="flex items-center justify-center gap-2 bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-300 p-4 rounded-2xl shadow-md hover:bg-green-200 dark:hover:bg-green-700 transition-all">
                            <i class="fas fa-plus-circle fa-lg"></i>
                            <span class="text-lg font-semibold" data-lang-key="dashboard.income">Доход</span>
                        </button>
                        <button id="nav-expense" class="flex items-center justify-center gap-2 bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300 p-4 rounded-2xl shadow-md hover:bg-red-200 dark:hover:bg-red-700 transition-all">
                            <i class="fas fa-minus-circle fa-lg"></i>
                            <span class="text-lg font-semibold" data-lang-key="dashboard.expense">Расход</span>
                        </button>
                    </div>

                    <!-- Слайдер Счетов -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white" data-lang-key="accounts.title">Счета</h2>
                            <button id="add-account-btn" class="text-blue-600 dark:text-blue-400 font-semibold text-sm hover:underline" data-lang-key="accounts.new">
                                + Новый счет
                            </button>
                        </div>
                        <div id="accounts-slider" class="slider-container flex overflow-x-auto gap-4 py-2 scroll-snap-x-mandatory">
                            <!-- Карточки счетов будут добавлены JS -->
                            <div id="no-accounts" class="text-center text-gray-500 dark:text-gray-400 w-full p-10" data-lang-key="accounts.noAccounts">
                                У вас пока нет счетов.
                            </div>
                        </div>
                    </div>

                    <!-- Слайдер Кредитов -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white" data-lang-key="loans.title">Кредиты</h2>
                            <button id="add-loan-btn" class="text-blue-600 dark:text-blue-400 font-semibold text-sm hover:underline" data-lang-key="loans.new">
                                + Новый кредит
                            </button>
                        </div>
                        <!-- УДАЛЕНО: div "Общий долг:" (перенесен выше) -->
                        <div id="loans-slider" class="slider-container flex overflow-x-auto gap-4 py-2 scroll-snap-x-mandatory">
                            <!-- Карточки кредитов будут добавлены JS -->
                            <div id="no-loans" class="text-center text-gray-500 dark:text-gray-400 w-full p-10" data-lang-key="loans.noLoans">
                                У вас нет активных кредитов.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Статус по кредитам -->
                    <div id="loan-status-widget">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-lang-key="loans.statusTitle">Статус по кредитам</h3>
                            <button id="toggle-loan-status" class="text-blue-600 dark:text-blue-400 text-sm p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="loan-status-content" class="space-y-3">
                            <!-- Статус будет добавлен JS -->
                        </div>
                    </div>

                </div> <!-- Конец левой колонки -->

                <!-- Правая колонка (История) -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white" data-lang-key="history.today">История (Сегодня)</h2>
                        <button id="show-all-history-btn" class="text-blue-600 dark:text-blue-400 font-semibold text-sm hover:underline">
                            <span data-lang-key="history.all">Все</span> <i class="fas fa-arrow-right text-xs"></i>
                        </button>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <div id="no-history" class="text-center text-gray-500 dark:text-gray-400 p-10 bg-white dark:bg-gray-800 rounded-2xl shadow-md" data-lang-key="history.noHistoryToday">
                            Сегодня операций не было.
                        </div>
                        <!-- Список транзакций будет добавлен JS -->
                    </div>
                </div> <!-- Конец правой колонки -->
            
            </div> <!-- Конец адаптивной сетки -->

        </div> <!-- Конец основного контента -->

    </div> <!-- Конец #main-app -->


    <!-- 
      Кастомное Toast уведомление
    -->
    <div id="toast-notification" class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-96 p-4 rounded-lg shadow-lg z-50 transition-all duration-500">
        <p id="toast-message" class="font-semibold text-white">Сообщение</p>
    </div>


    <!-- 
      СКРИПТЫ
    -->
    
    <!-- Firebase -->
    <script type="module">
        // Импорты Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- ИЗМЕНЕНО: ИМПОРТЫ REALTIME DATABASE ---
        import {
            getDatabase,
            ref,
            onValue,
            set,
            push,
            remove,
            runTransaction,
            serverTimestamp,
            query as dbQuery, // Переименовываем, чтобы не конфликтовать с query Firestore (хотя мы его удалили)
            orderByChild,
            equalTo,
            get, // <-- ИСПРАВЛЕНИЕ: Добавлен get
            update // <-- НОВОЕ: Для drag-n-drop
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- 0. КОНФИГУРАЦИЯ FIREBASE (ВАЖНО!) ---
        
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!                                              !!
        // !!  ШАГ 1: ВСТАВЬ СЮДА СВОЙ firebaseConfig       !!
        // !!                                              !!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
            apiKey: "AIzaSyDoYzo2ntwZ_nbnzh5f967tmR8f31Y-dPc",
            authDomain: "budgetapp-a5883.firebaseapp.com",
            databaseURL: "https://budgetapp-a5883-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "budgetapp-a5883",
            storageBucket: "budgetapp-a5883.firebasestorage.app",
            messagingSenderId: "839768191708",
            appId: "1:839768191708:web:3e901d3f4656f80faaba19",
            measurementId: "G-N2M6D4FMZ6"
        };
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


        // --- Инициализация ---
        let app, auth, db; // db теперь это Realtime Database
        let currentUserId = null;
        let currentLang = 'ru'; // Язык по умолчанию
        
        // Глобальные состояния
        let allTransactions = [];
        let allAccounts = [];
        let allLoans = [];
        let currentBudgetModel = 'none';
        
        // Ссылки на слушатели RTDB (чтобы их можно было отключать)
        let accountsListener = null;
        let loansListener = null;
        let transactionsListener = null;

        // Форматтер валют
        const formatter = new Intl.NumberFormat('kk-KZ', { 
            style: 'currency', 
            currency: 'KZT',
            currencyDisplay: 'narrowSymbol',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });
        
        // --- НОВОЕ: Словарь локализации ---
        const translations = {
            ru: {
                "auth.login": "Вход",
                "auth.register": "Регистрация",
                "auth.email": "Email",
                "auth.password": "Пароль",
                "auth.passwordPlaceholder": "Мин. 6 символов",
                "auth.loginButton": "Войти",
                "auth.registerButton": "Создать аккаунт",
                "auth.error.invalid-email": "Неверный формат Email.",
                "auth.error.user-not-found": "Пользователь не найден.",
                "auth.error.wrong-password": "Неверный пароль.",
                "auth.error.email-already-in-use": "Этот Email уже используется.",
                "auth.error.weak-password": "Пароль слишком слабый (мин. 6 символов).",
                "auth.error.invalid-credential": "Неверный Email или пароль.",
                "auth.error.default": "Произошла ошибка. Попробуйте снова.",
                "dashboard.title": "MyFin",
                "dashboard.totalBalance": "Общий баланс",
                "dashboard.savings": "Сбережения",
                "dashboard.income": "Доход",
                "dashboard.expense": "Расход",
                "accounts.title": "Счета",
                "accounts.new": "+ Новый счет",
                "accounts.noAccounts": "У вас пока нет счетов.",
                "accounts.balance": "Баланс",
                "accounts.deleted": "Счет удален",
                "loans.title": "Кредиты",
                "loans.new": "+ Новый кредит",
                "loans.totalDebt": "Общий долг:",
                "loans.noLoans": "У вас нет активных кредитов.",
                "loans.statusTitle": "Статус по кредитам",
                "loans.paid": "Оплачено",
                "loans.total": "Всего",
                "loans.monthlyPayment": "Ежемес. платеж:",
                "loans.remainingMonths": "{{months}} мес. осталось",
                "loans.paidOff": "Выплачено",
                "loans.paymentDate": "Платеж до {{date}} числа",
                "history.today": "История (Сегодня)",
                "history.all": "Все",
                "history.allTitle": "Вся история",
                "history.noHistoryToday": "Сегодня операций не было.",
                "history.noHistory": "История операций пуста.",
                "history.transferTo": "Перевод на \"{{accountName}}\"",
                "settings.title": "Настройки",
                "settings.budgetModel": "Модель Управления",
                "settings.modelNone": "Не выбрана",
                "settings.modelSelectPrompt": "Выберите модель, чтобы увидеть распределение.",
                "settings.modelSelectPromptShort": "Выберите модель бюджета в настройках",
                "settings.language": "Язык",
                "settings.loggedInAs": "Вы вошли как:",
                "settings.logout": "Выйти",
                "forms.newIncome": "Новый Доход",
                "forms.newExpense": "Новый Расход",
                "forms.addIncomeButton": "Добавить Доход",
                "forms.addExpenseButton": "Добавить Расход",
                "forms.description": "Описание",
                "forms.descriptionPlaceholder": "Напр., Покупка в Magnum",
                "forms.amount": "Сумма (₸)",
                "forms.account": "Счет",
                "forms.accountFrom": "Счет (Откуда)",
                "forms.category": "Категория",
                "forms.whichLoan": "Какой кредит оплачиваете?",
                "forms.whichSavingsAccount": "На какой сберегательный счет?",
                "forms.newAccountTitle": "Новый счет",
                "forms.accountType": "Тип счета",
                "forms.selectBank": "Выберите банк",
                "forms.accountName": "Название",
                "forms.accountNamePlaceholder": "Напр., Kaspi Bank",
                "forms.currentBalance": "Текущий баланс (₸)",
                "forms.cardColor": "Цвет карты",
                "forms.addAccountButton": "Добавить счет",
                "forms.newLoanTitle": "Новый кредит",
                "forms.loanName": "Название",
                "forms.loanNamePlaceholder": "Напр., Автокредит",
                "forms.loanTotalAmount": "Общая сумма (₸)",
                "forms.loanPaidAmount": "Уже оплачено (₸)",
                "forms.loanMonthlyPayment": "Ежемесячный платеж (₸)",
                "forms.loanPaymentDate": "Число ежемесячного платежа",
                "forms.addLoanButton": "Добавить кредит",
                "forms.noAccountFirst": "Сначала добавьте счет",
                "forms.noActiveLoans": "Нет активных кредитов",
                "forms.selectLoan": "Выберите кредит...",
                "forms.noSavingsAccounts": "Нет сберегательных счетов",
                "forms.selectAccount": "Выберите счет...",
                "forms.fillAllFields": "Пожалуйста, заполните все поля.",
                "forms.selectSavingsAccount": "Пожалуйста, выберите сберегательный счет.",
                "forms.noSameAccountTransfer": "Нельзя перевести деньги на тот же счет.",
                "toast.accountAdded": "Счет успешно добавлен!",
                "toast.accountAddError": "Ошибка добавления счета.",
                "toast.loanAdded": "Кредит успешно добавлен!",
                "toast.loanAddError": "Ошибка добавления кредита.",
                "toast.transactionAdded": "Транзакция ({{type}}) добавлена!",
                "toast.transactionType.income": "Доход",
                "toast.transactionType.expense": "Расход",
                "toast.transactionAddError": "Ошибка добавления транзакции.",
                "toast.deleteAccountError": "Нельзя удалить счет, к которому привязаны транзакции.",
                "toast.accountDeleted": "Счет успешно удален.",
                "toast.deleteAccountErrorGeneric": "Ошибка удаления счета.",
                "toast.deleteLoanError": "Нельзя удалить кредит, по которому были платежи.",
                "toast.loanDeleted": "Кредит успешно удален.",
                "toast.deleteLoanErrorGeneric": "Ошибка удаления кредита.",
                "toast.logoutError": "Ошибка при выходе.",
                "toast.orderSaved": "Порядок счетов сохранен!",
                "toast.orderSaveError": "Ошибка сохранения порядка.",
                "accountTypes.bank": "Банк",
                "accountTypes.deposit": "Депозит",
                "accountTypes.savings": "Сбережение",
                "accountTypes.cash": "Наличный",
                "accountTypes.defaultSavings": "Сберегательный счет",
                "categories.model.50-30-20.needs": "Нужды (50%)",
                "categories.model.50-30-20.wants": "Желания (30%)",
                "categories.model.50-30-20.savings": "Сбережения (20% - Перевод)",
                "categories.model.80-20.expenses": "Расходы (80%)",
                "categories.model.80-20.savings": "Сбережения (20% - Перевод)",
                "categories.model.none.needs": "Нужды",
                "categories.model.none.wants": "Желания",
                "categories.model.none.savings": "Сбережения (Перевод)",
                "categories.loan": "Оплата кредита",
                "categories.other": "Другое",
                "budgetModel.income": "Месячный доход: {{amount}}",
                "budgetModel.needs": "Нужды (50%)",
                "budgetModel.wants": "Желания (30%)",
                "budgetModel.savings": "Сбережения (20%)",
                "budgetModel.expenses": "Расходы (80%)",
                "budgetModel.savings_80": "Сбережения (20%)",
                "loanStatus.paid": "Оплачено в этом месяце",
                "loanStatus.overdue": "ПЛАТЕЖ ПРОСРОЧЕН!",
                "loanStatus.dueSoon": "Срок оплаты через {{days}} дн.",
                "loanStatus.due": "Оплата до {{date}} числа"
            },
            kk: {
                "auth.login": "Кіру",
                "auth.register": "Тіркелу",
                "auth.email": "Email",
                "auth.password": "Құпия сөз",
                "auth.passwordPlaceholder": "Кемі 6 таңба",
                "auth.loginButton": "Кіру",
                "auth.registerButton": "Аккаунт құру",
                "auth.error.invalid-email": "Email пішімі қате.",
                "auth.error.user-not-found": "Пайдаланушы табылмады.",
                "auth.error.wrong-password": "Құпия сөз қате.",
                "auth.error.email-already-in-use": "Бұл Email бұрыннан қолданыста.",
                "auth.error.weak-password": "Құпия сөз тым әлсіз (кемі 6 таңба).",
                "auth.error.invalid-credential": "Email немесе құпия сөз қате.",
                "auth.error.default": "Қате орын алды. Қайталап көріңіз.",
                "dashboard.title": "MyFin",
                "dashboard.totalBalance": "Жалпы баланс",
                "dashboard.savings": "Жинақтар",
                "dashboard.income": "Кіріс",
                "dashboard.expense": "Шығыс",
                "accounts.title": "Шоттар",
                "accounts.new": "+ Жаңа шот",
                "accounts.noAccounts": "Сізде әзірге шоттар жоқ.",
                "accounts.balance": "Баланс",
                "accounts.deleted": "Шот жойылды",
                "loans.title": "Несиелер",
                "loans.new": "+ Жаңа несие",
                "loans.totalDebt": "Жалпы қарыз:",
                "loans.noLoans": "Сізде белсенді несиелер жоқ.",
                "loans.statusTitle": "Несие статусы",
                "loans.paid": "Төленді",
                "loans.total": "Барлығы",
                "loans.monthlyPayment": "Айлық төлем:",
                "loans.remainingMonths": "{{months}} ай қалды",
                "loans.paidOff": "Төленіп бітті",
                "loans.paymentDate": "{{date}} дейін төлем",
                "history.today": "Тарих (Бүгін)",
                "history.all": "Барлығы",
                "history.allTitle": "Барлық тарих",
                "history.noHistoryToday": "Бүгін операциялар болмады.",
                "history.noHistory": "Операциялар тарихы бос.",
                "history.transferTo": "\"{{accountName}}\" шотына аударым",
                "settings.title": "Баптаулар",
                "settings.budgetModel": "Басқару моделі",
                "settings.modelNone": "Таңдалмады",
                "settings.modelSelectPrompt": "Бөлінуді көру үшін үлгіні таңдаңыз.",
                "settings.modelSelectPromptShort": "Баптаулардан бюджет үлгісін таңдаңыз",
                "settings.language": "Тіл",
                "settings.loggedInAs": "Сіз осы аккаунтпен кірдіңіз:",
                "settings.logout": "Шығу",
                "forms.newIncome": "Жаңа Кіріс",
                "forms.newExpense": "Жаңа Шығыс",
                "forms.addIncomeButton": "Кіріс қосу",
                "forms.addExpenseButton": "Шығыс қосу",
                "forms.description": "Сипаттамасы",
                "forms.descriptionPlaceholder": "Мыс., Magnum-дағы сауда",
                "forms.amount": "Сома (₸)",
                "forms.account": "Шот",
                "forms.accountFrom": "Шот (Қайдан)",
                "forms.category": "Санат",
                "forms.whichLoan": "Қай несиені төлейсіз?",
                "forms.whichSavingsAccount": "Қай жинақ шотына?",
                "forms.newAccountTitle": "Жаңа шот",
                "forms.accountType": "Шот түрі",
                "forms.selectBank": "Банкті таңдаңыз",
                "forms.accountName": "Атауы",
                "forms.accountNamePlaceholder": "Мыс., Kaspi Bank",
                "forms.currentBalance": "Ағымдағы баланс (₸)",
                "forms.cardColor": "Карта түсі",
                "forms.addAccountButton": "Шот қосу",
                "forms.newLoanTitle": "Жаңа несие",
                "forms.loanName": "Атауы",
                "forms.loanNamePlaceholder": "Мыс., Автонесие",
                "forms.loanTotalAmount": "Жалпы сома (₸)",
                "forms.loanPaidAmount": "Төленгені (₸)",
                "forms.loanMonthlyPayment": "Айлық төлем (₸)",
                "forms.loanPaymentDate": "Ай сайынғы төлем күні",
                "forms.addLoanButton": "Несие қосу",
                "forms.noAccountFirst": "Алдымен шот қосыңыз",
                "forms.noActiveLoans": "Белсенді несиелер жоқ",
                "forms.selectLoan": "Несиені таңдаңыз...",
                "forms.noSavingsAccounts": "Жинақ шоттары жоқ",
                "forms.selectAccount": "Шотты таңдаңыз...",
                "forms.fillAllFields": "Барлық өрістерді толтырыңыз.",
                "forms.selectSavingsAccount": "Жинақ шотын таңдаңыз.",
                "forms.noSameAccountTransfer": "Ақшаны бір шотқа аудару мүмкін емес.",
                "toast.accountAdded": "Шот сәтті қосылды!",
                "toast.accountAddError": "Шотты қосу қатесі.",
                "toast.loanAdded": "Несие сәтті қосылды!",
                "toast.loanAddError": "Несиені қосу қатесі.",
                "toast.transactionAdded": "Транзакция ({{type}}) қосылды!",
                "toast.transactionType.income": "Кіріс",
                "toast.transactionType.expense": "Шығыс",
                "toast.transactionAddError": "Транзакцияны қосу қатесі.",
                "toast.deleteAccountError": "Транзакциялары бар шотты жою мүмкін емес.",
                "toast.accountDeleted": "Шот сәтті жойылды.",
                "toast.deleteAccountErrorGeneric": "Шотты жою қатесі.",
                "toast.deleteLoanError": "Төлемдері бар несиені жою мүмкін емес.",
                "toast.loanDeleted": "Несие сәтті жойылды.",
                "toast.deleteLoanErrorGeneric": "Несиені жою қатесі.",
                "toast.logoutError": "Шығу кезінде қате.",
                "toast.orderSaved": "Шоттардың реті сақталды!",
                "toast.orderSaveError": "Ретті сақтау қатесі.",
                "accountTypes.bank": "Банк",
                "accountTypes.deposit": "Депозит",
                "accountTypes.savings": "Жинақ",
                "accountTypes.cash": "Қолма-қол",
                "accountTypes.defaultSavings": "Жинақ шоты",
                "categories.model.50-30-20.needs": "Қажеттіліктер (50%)",
                "categories.model.50-30-20.wants": "Қалаулар (30%)",
                "categories.model.50-30-20.savings": "Жинақ (20% - Аударым)",
                "categories.model.80-20.expenses": "Шығыстар (80%)",
                "categories.model.80-20.savings": "Жинақ (20% - Аударым)",
                "categories.model.none.needs": "Қажеттіліктер",
                "categories.model.none.wants": "Қалаулар",
                "categories.model.none.savings": "Жинақ (Аударым)",
                "categories.loan": "Несие төлемі",
                "categories.other": "Басқа",
                "budgetModel.income": "Айлық табыс: {{amount}}",
                "budgetModel.needs": "Қажеттіліктер (50%)",
                "budgetModel.wants": "Қалаулар (30%)",
                "budgetModel.savings": "Жинақ (20%)",
                "budgetModel.expenses": "Шығыстар (80%)",
                "budgetModel.savings_80": "Жинақ (20%)",
                "loanStatus.paid": "Осы айда төленді",
                "loanStatus.overdue": "ТӨЛЕМ МЕРЗІМІ ӨТІП КЕТТІ!",
                "loanStatus.dueSoon": "Төлем {{days}} күннен кейін.",
                "loanStatus.due": "{{date}} дейін төлеу"
            }
        };

        // НОВЫЕ Функции локализации
        function t(key, replacements = {}) {
            let text = translations[currentLang][key] || key;
            for (const rKey in replacements) {
                text = text.replace(`{{${rKey}}}`, replacements[rKey]);
            }
            return text;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang;
            
            // Update buttons
            document.getElementById('lang-ru').dataset.active = lang === 'ru';
            document.getElementById('lang-kk').dataset.active = lang === 'kk';

            // Update static text
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                el.textContent = t(el.dataset.langKey);
            });
            // Update placeholders
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                el.placeholder = t(el.dataset.langKeyPlaceholder);
            });
            
            // Re-render all dynamic content
            if (currentUserId) {
                renderAccounts();
                renderLoans();
                renderHistory();
                renderAllHistory();
                renderBudgetModels();
                renderLoanStatus();
                updateBalances();
                populateAccountSelect();
                populateCategories();
            }
            // Update auth error messages if visible
            if (!currentUserId) {
                authError.textContent = authError.dataset.lastErrorKey ? t(authError.dataset.lastErrorKey) : '';
            }
        }
        
        // Элементы DOM
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app');
        
        // Элементы Auth
        const authTabLogin = document.getElementById('auth-tab-login');
        const authTabRegister = document.getElementById('auth-tab-register');
        const authFormLogin = document.getElementById('auth-form-login');
        const authFormRegister = document.getElementById('auth-form-register');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        
        // ... (все остальные элементы DOM, как и раньше)
        const totalBalanceEl = document.getElementById('total-balance');
        const savingsBalanceEl = document.getElementById('savings-balance');
        const accountsSlider = document.getElementById('accounts-slider');
        const loansSlider = document.getElementById('loans-slider');
        const historyList = document.getElementById('history-list');
        const noAccountsEl = document.getElementById('no-accounts');
        const noLoansEl = document.getElementById('no-loans');
        const noHistoryEl = document.getElementById('no-history');
        const loanStatusWidget = document.getElementById('loan-status-widget');
        const budgetModelSelect = document.getElementById('budget-model-select');
        const drawerModelDisplay = document.getElementById('model-display');
        const mainModelDisplay = document.getElementById('main-model-display'); 
        const navIncome = document.getElementById('nav-income');
        const navExpense = document.getElementById('nav-expense');
        const transactionModal = document.getElementById('transaction-modal');
        const closeTransactionModal = document.getElementById('close-transaction-modal');
        const transactionModalTitle = document.getElementById('transaction-modal-title');
        const transactionForm = document.getElementById('transaction-form');
        const transactionCategory = document.getElementById('transaction-category');
        const loanPaymentContainer = document.getElementById('loan-payment-container');
        const transactionLoanSelect = document.getElementById('transaction-loan-select');
        const savingsTransferContainer = document.getElementById('savings-transfer-container');
        const transactionSavingsSelect = document.getElementById('transaction-savings-select');
        const submitTransactionBtn = document.getElementById('submit-transaction-btn');
        const transactionAccountSelect = document.getElementById('transaction-account');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const accountModal = document.getElementById('account-modal');
        const addAccountBtn = document.getElementById('add-account-btn');
        const closeAccountModal = document.getElementById('close-account-modal');
        const accountForm = document.getElementById('account-form');
        const accountTypeSelect = document.getElementById('account-type');
        const bankLogoContainer = document.getElementById('bank-logo-container');
        const bankLogoInputs = document.querySelectorAll('.bank-logo');
        const accountLogoUrlInput = document.getElementById('account-logo-url');
        const accountNameInput = document.getElementById('account-name');
        const colorPicker = document.getElementById('color-picker');
        const colorSwatches = document.querySelectorAll('.color-swatch');
        const accountColorInput = document.getElementById('account-color');
        const loanModal = document.getElementById('loan-modal');
        const addLoanBtn = document.getElementById('add-loan-btn');
        const closeLoanModal = document.getElementById('close-loan-modal');
        const loanForm = document.getElementById('loan-form');
        const menuToggle = document.getElementById('menu-toggle');
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const drawerContent = document.getElementById('drawer-content');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const showAllHistoryBtn = document.getElementById('show-all-history-btn');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');
        const allHistoryContent = document.getElementById('all-history-content');
        const langBtnRu = document.getElementById('lang-ru');
        const langBtnKk = document.getElementById('lang-kk');
        const toggleLoanStatusBtn = document.getElementById('toggle-loan-status');
        
        // --- 1. Инициализация Firebase и Аутентификация ---
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Инициализируем Firebase с ТВОИМ конфигом
                app = initializeApp(firebaseConfig);
                db = getDatabase(app); // --- ИЗМЕНЕНО ---
                auth = getAuth(app);
                
                // setLogLevel('debug'); // Недоступно для RTDB

                // --- НОВЫЕ СЛУШАТЕЛИ AUTH ---
                authTabLogin.addEventListener('click', () => toggleAuthTabs(true));
                authTabRegister.addEventListener('click', () => toggleAuthTabs(false));
                authFormLogin.addEventListener('submit', handleLogin);
                authFormRegister.addEventListener('submit', handleRegister);
                logoutButton.addEventListener('click', handleLogout);

                // --- Старые слушатели ---
                menuToggle.addEventListener('click', () => toggleDrawer(true));
                drawerBackdrop.addEventListener('click', () => toggleDrawer(false));
                navIncome.addEventListener('click', () => openTransactionModal('income'));
                navExpense.addEventListener('click', () => openTransactionModal('expense'));
                addAccountBtn.addEventListener('click', () => toggleModal('account-modal', true));
                closeAccountModal.addEventListener('click', () => toggleModal('account-modal', false));
                accountForm.addEventListener('submit', handleAccountSubmit);
                addLoanBtn.addEventListener('click', () => toggleModal('loan-modal', true));
                closeLoanModal.addEventListener('click', () => toggleModal('loan-modal', false));
                loanForm.addEventListener('submit', handleLoanSubmit);
                closeTransactionModal.addEventListener('click', () => toggleModal('transaction-modal', false));
                transactionForm.addEventListener('submit', handleTransactionSubmit);
                showAllHistoryBtn.addEventListener('click', () => toggleModal('history-modal', true));
                closeHistoryModal.addEventListener('click', () => toggleModal('history-modal', false));
                setupAccountModalUI();
                transactionCategory.addEventListener('change', handleCategoryChange);
                budgetModelSelect.addEventListener('change', renderBudgetModels);

                // --- НОВЫЕ слушатели ---
                langBtnRu.addEventListener('click', () => setLanguage('ru'));
                langBtnKk.addEventListener('click', () => setLanguage('kk'));
                toggleLoanStatusBtn.addEventListener('click', toggleLoanStatusVisibility);
                
                // Drag-n-Drop
                accountsSlider.addEventListener('dragstart', handleDragStart);
                accountsSlider.addEventListener('dragover', handleDragOver);
                accountsSlider.addEventListener('dragleave', handleDragLeave);
                accountsSlider.addEventListener('drop', handleDrop);
                accountsSlider.addEventListener('dragend', handleDragEnd);

                // НОВОЕ: Drag-n-Drop (Touch)
                accountsSlider.addEventListener('touchstart', handleTouchStart, { passive: false });
                accountsSlider.addEventListener('touchmove', handleTouchMove, { passive: false });
                accountsSlider.addEventListener('touchend', handleTouchEnd);

                // Запускаем главный процесс аутентификации
                setupAuthListener();
                
                // Устанавливаем язык из localStorage
                setLanguage(localStorage.getItem('appLanguage') || 'ru');

            } catch (error) {
                console.error("Ошибка инициализации Firebase:", error);
                authError.textContent = "Ошибка инициализации Firebase. Твой 'firebaseConfig' указан верно?";
                authContainer.classList.remove('hidden'); // Показать экран входа, чтобы была видна ошибка
            }
        });
        
        // ГЛАВНЫЙ СЛУШАТЕЛЬ AUTH
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Пользователь вошел
                    currentUserId = user.uid;
                    document.getElementById('user-email-display').textContent = user.email;
                    
                    // Показываем приложение, скрываем Auth
                    authContainer.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                    
                    // Запускаем загрузку данных
                    await initializeDataListeners();
                } else {
                    // Пользователь не вошел (или нажал "Выйти")
                    currentUserId = null;
                    
                    // Показываем Auth, скрываем приложение
                    authContainer.classList.remove('hidden');
                    mainAppContainer.classList.add('hidden');
                    
                    // ОЧИЩАЕМ все данные с экрана
                    clearAllLocalData();
                }
            });
        }
        
        // --- 2. Загрузка данных (Listeners) ---
        
        // --- ИЗМЕНЕНО: ЛОГИКА REALTIME DATABASE ---
        
        async function initializeDataListeners() {
            if (!currentUserId) return;
            
            // Отключаем старые слушатели, если они есть
            if (accountsListener) accountsListener();
            if (loansListener) loansListener();
            if (transactionsListener) transactionsListener();

            // 1. Слушатель Счетов
            const accountsRef = ref(db, `users/${currentUserId}/accounts`);
            accountsListener = onValue(accountsRef, (snapshot) => {
                const data = snapshot.val() || {};
                allAccounts = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                allAccounts.sort((a, b) => (a.order || 0) - (b.order || 0)); // Сортируем по 'order'
                renderAccounts();
                updateBalances();
                populateAccountSelect();
            }, (error) => console.error("Ошибка загрузки счетов:", error));

            // 2. Слушатель Кредитов
            const loansRef = ref(db, `users/${currentUserId}/loans`);
            loansListener = onValue(loansRef, (snapshot) => {
                const data = snapshot.val() || {};
                allLoans = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                allLoans.sort((a, b) => a.paymentDate - b.paymentDate); // Сортируем по дате платежа
                renderLoans();
                renderLoanStatus();
            }, (error) => console.error("Ошибка загрузки кредитов:", error));

            // 3. Слушатель Транзакций
            const transRef = ref(db, `users/${currentUserId}/transactions`);
            transactionsListener = onValue(transRef, (snapshot) => {
                const data = snapshot.val() || {};
                allTransactions = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                // Сортируем: новые вверху
                allTransactions.sort((a, b) => b.createdAt - a.createdAt);
                
                renderHistory(); // Рендер "Сегодня"
                renderAllHistory(); // Рендер "Всей истории" в модалке
                updateBalances(); // Обновляем балансы
                renderBudgetModels(); // Обновляем модели
                renderLoans(); // <-- НОВОЕ: Пересчитываем общий долг
                renderLoanStatus(); // Обновляем статус кредитов
            }, (error) => console.error("Ошибка загрузки транзакций:", error));
        }
        
        // НОВАЯ ФУНКЦИЯ: Очистка данных при выходе
        function clearAllLocalData() {
            // Отключаем слушатели
            if (accountsListener) accountsListener();
            if (loansListener) loansListener();
            if (transactionsListener) transactionsListener();
            
            accountsListener = null;
            loansListener = null;
            transactionsListener = null;

            allTransactions = [];
            allAccounts = [];
            allLoans = [];
            
            renderAccounts();
            renderLoans();
            renderHistory();
            renderAllHistory();
            updateBalances();
            renderBudgetModels();
            renderLoanStatus();
            
            // Сбрасываем drawer
            drawerModelDisplay.innerHTML = `<p class="text-gray-500 dark:text-gray-400" data-lang-key="settings.modelSelectPrompt">${t('settings.modelSelectPrompt')}</p>`;
            budgetModelSelect.value = 'none';
        }


        // --- 3. Функции UI (Вспомогательные) ---
        
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function toggleDrawer(show) {
            if (show) {
                drawerBackdrop.classList.remove('hidden');
                drawerBackdrop.style.opacity = '1';
                drawerContent.classList.remove('-translate-x-full');
            } else {
                drawerBackdrop.style.opacity = '0';
                drawerContent.classList.add('-translate-x-full');
                setTimeout(() => drawerBackdrop.classList.add('hidden'), 300);
            }
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-96 p-4 rounded-lg shadow-lg z-50 transition-all duration-500 show ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function toggleAuthTabs(showLogin) {
            authError.textContent = ''; // Очищаем ошибки
            authError.dataset.lastErrorKey = '';
            if (showLogin) {
                authTabLogin.classList.add('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
                authTabLogin.classList.remove('text-gray-500', 'dark:text-gray-400');
                
                authTabRegister.classList.remove('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
                authTabRegister.classList.add('text-gray-500', 'dark:text-gray-400');

                authFormLogin.classList.remove('hidden');
                authFormRegister.classList.add('hidden');
            } else {
                authTabLogin.classList.remove('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
                authTabLogin.classList.add('text-gray-500', 'dark:text-gray-400');
                
                authTabRegister.classList.add('border-blue-600', 'dark:border-blue-400', 'text-blue-600', 'dark:text-blue-400');
                authTabRegister.classList.remove('text-gray-500', 'dark:text-gray-400');

                authFormLogin.classList.add('hidden');
                authFormRegister.classList.remove('hidden');
            }
        }

        // --- НОВАЯ ФУНКЦИЯ: Показать/Скрыть Статус Кредитов ---
        function toggleLoanStatusVisibility() {
            const content = document.getElementById('loan-status-content');
            const icon = toggleLoanStatusBtn.querySelector('i');
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                localStorage.setItem('loanStatusHidden', 'true');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                localStorage.removeItem('loanStatusHidden');
            }
        }

        // --- 4. Логика обновления UI (без изменений, кроме createdAt.toDate()) ---

        // Обновление Общих Балансов
        function updateBalances() {
            let total = 0;
            let savings = 0;
            allAccounts.forEach(acc => {
                total += acc.balance;
                if (acc.type === 'savings' || acc.type === 'deposit') {
                    savings += acc.balance;
                }
            });
            totalBalanceEl.textContent = formatter.format(total);
            savingsBalanceEl.textContent = formatter.format(savings);
        }

        // Рендер Слайдера Счетов
        function renderAccounts() {
            if (allAccounts.length === 0) {
                noAccountsEl.classList.remove('hidden');
                accountsSlider.innerHTML = '';
                accountsSlider.appendChild(noAccountsEl);
                return;
            }
            noAccountsEl.classList.add('hidden');
            accountsSlider.innerHTML = '';
            allAccounts.forEach(account => {
                const card = document.createElement('div');
                const colorClass = account.color || 'from-gray-500 to-gray-700';
                card.className = `slider-item bg-gradient-to-br ${colorClass} p-5 rounded-2xl shadow-lg text-white flex flex-col justify-between h-48 relative overflow-hidden cursor-grab`;
                card.draggable = true; // <-- НОВОЕ: Drag-n-Drop
                card.dataset.accountId = account.id; // <-- НОВОЕ: Drag-n-Drop

                let logoHtml = '';
                if (account.logoUrl) {
                    logoHtml = `
                        <div class="absolute top-4 left-4 w-10 h-10 bg-white rounded-full p-1 flex items-center justify-center shadow">
                            <img src="${account.logoUrl}" alt="${account.name} logo" class="w-full h-full object-contain" 
                                 onerror="this.parentElement.innerHTML = '${account.name.charAt(0)}'; this.parentElement.classList.add('logo-fallback');">
                        </div>`;
                }
                const typeText = { bank: t('accountTypes.bank'), deposit: t('accountTypes.deposit'), savings: t('accountTypes.savings'), cash: t('accountTypes.cash') };
                card.innerHTML = `
                    ${logoHtml}
                    <button class="delete-account-btn absolute top-2 right-2 w-7 h-7 bg-black bg-opacity-20 rounded-full text-white text-xs hover:bg-opacity-40 z-10">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="z-0">
                        <span class="block text-sm font-medium opacity-80 ${account.logoUrl ? 'text-right' : ''}">${typeText[account.type] || t('forms.account')}</span>
                        <span class="block text-lg font-semibold truncate ${account.logoUrl ? 'text-right' : ''}">${account.name}</span>
                    </div>
                    <div class="z-0">
                        <span class="block text-xs opacity-80" data-lang-key="accounts.balance">${t('accounts.balance')}</span>
                        <p class="text-3xl font-bold truncate">${formatter.format(account.balance)}</p>
                    </div>
                `;
                card.querySelector('.delete-account-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteAccount(account.id);
                });
                accountsSlider.appendChild(card);
            });
        }
        
        // Рендер Слайдера Кредитов
        function renderLoans() {
            // НОВОЕ: Рассчитываем общий долг
            const totalDebt = allLoans.reduce((acc, loan) => acc + (loan.totalAmount - loan.paidAmount), 0);
            document.getElementById('total-loan-balance').textContent = formatter.format(Math.max(0, totalDebt));
            
            if (allLoans.length === 0) {
                noLoansEl.classList.remove('hidden');
                loansSlider.innerHTML = '';
                loansSlider.appendChild(noLoansEl);
                return;
            }
            noLoansEl.classList.add('hidden');
            loansSlider.innerHTML = '';
            allLoans.forEach(loan => {
                const card = document.createElement('div');
                const progress = (loan.paidAmount / loan.totalAmount) * 100;
                const remainingAmount = loan.totalAmount - loan.paidAmount;
                const remainingMonths = (loan.monthlyPayment > 0) ? Math.ceil(remainingAmount / loan.monthlyPayment) : 0;
                const monthsText = (remainingAmount <= 0) ? t('loans.paidOff') : (remainingMonths > 0 ? t('loans.remainingMonths', {months: remainingMonths}) : 'N/A');
                card.className = 'slider-item bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md flex flex-col justify-between h-60 relative';
                card.innerHTML = `
                    <button class="delete-loan-btn absolute top-2 right-2 w-7 h-7 bg-gray-100 dark:bg-gray-700 rounded-full text-gray-500 dark:text-gray-400 text-xs hover:bg-gray-200 dark:hover:bg-gray-600 z-10">
                        <i class="fas fa-times"></i>
                    </button>
                    <div>
                        <span class="block text-sm font-medium text-gray-500 dark:text-gray-400" data-lang-key="loans.title">${t('loans.title')}</span>
                        <span class="block text-lg font-semibold truncate text-gray-900 dark:text-white">${loan.name}</span>
                        <span class="block text-sm font-medium text-gray-500 dark:text-gray-400 mt-1">
                            ${t('loans.paymentDate', {date: loan.paymentDate})}
                        </span>
                    </div>
                    <div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600 dark:text-gray-300" data-lang-key="loans.paid">${t('loans.paid')}</span>
                            <span class="font-semibold text-gray-900 dark:text-white">${formatter.format(loan.paidAmount)}</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span data-lang-key="loans.total">${t('loans.total')}</span>
                            <span>${formatter.format(loan.totalAmount)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t dark:border-gray-700">
                        <span class="text-sm text-gray-600 dark:text-gray-300"><span data-lang-key="loans.monthlyPayment">${t('loans.monthlyPayment')}</span> <br> <strong class="text-base text-gray-900 dark:text-white">${formatter.format(loan.monthlyPayment)}</strong></span>
                        <span class="text-sm font-semibold text-blue-600 dark:text-blue-400">${monthsText}</span>
                    </div>
                `;
                card.querySelector('.delete-loan-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleDeleteLoan(loan.id);
                });
                loansSlider.appendChild(card);
            });
        }

        // Рендер Истории (Только "Сегодня")
        function renderHistory() {
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const todayTransactions = allTransactions.filter(t => t.createdAt >= todayStart.getTime());
            if (todayTransactions.length === 0) {
                noHistoryEl.classList.remove('hidden');
                historyList.innerHTML = '';
                historyList.appendChild(noHistoryEl);
                return;
            }
            noHistoryEl.classList.add('hidden');
            historyList.innerHTML = '';
            todayTransactions.forEach(trans => historyList.appendChild(createTransactionElement(trans)));
        }
        
        // Рендер Модального Окна "Вся История"
        function renderAllHistory() {
            if (allTransactions.length === 0) {
                allHistoryContent.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-10" data-lang-key="history.noHistory">${t('history.noHistory')}</p>`;
                return;
            }
            allHistoryContent.innerHTML = '';
            const grouped = allTransactions.reduce((acc, trans) => {
                const date = new Date(trans.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
                if (!acc[date]) acc[date] = [];
                acc[date].push(trans);
                return acc;
            }, {});
            const sortedDates = Object.keys(grouped);
            sortedDates.forEach(date => {
                const dateGroupEl = document.createElement('div');
                dateGroupEl.innerHTML = `<h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">${date}</h3>`;
                const transactionsEl = document.createElement('div');
                transactionsEl.className = "bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden";
                grouped[date].forEach((trans, index) => {
                    const transEl = createTransactionElement(trans);
                    transEl.className = "flex items-center justify-between p-4"; 
                    if (index > 0) transEl.classList.add("border-t", "dark:border-gray-700");
                    transactionsEl.appendChild(transEl);
                });
                dateGroupEl.appendChild(transactionsEl);
                allHistoryContent.appendChild(dateGroupEl);
            });
        }

        // Вспомогательная функция для создания элемента транзакции
        function createTransactionElement(trans) {
            const element = document.createElement('div');
            const account = allAccounts.find(a => a.id === trans.accountId);
            const isIncome = trans.type === 'income';
            let description = trans.description;
            let icon = isIncome ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500';
            let iconBg = isIncome ? 'bg-green-100 dark:bg-green-800' : 'bg-red-100 dark:bg-red-800';
            let amountColor = isIncome ? 'text-green-600 dark:text-green-500' : 'text-red-600 dark:text-red-500';
            let sign = isIncome ? '+' : '-';
            const isSavings = trans.category === 'savings-503020' || trans.category === 'savings-8020' || trans.category === 'savings';
            if (isSavings) {
                const toAccount = allAccounts.find(a => a.id === trans.toAccountId);
                description = t('history.transferTo', { accountName: toAccount ? toAccount.name : t('dashboard.savings') });
                icon = 'fa-exchange-alt text-blue-500';
                iconBg = 'bg-blue-100 dark:bg-blue-800';
            }
            element.className = 'bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md flex items-center justify-between';
            element.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${iconBg}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white truncate max-w-[150px] sm:max-w-xs">${description}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${account ? account.name : t('accounts.deleted')} | ${new Date(trans.createdAt).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold ${amountColor}">
                        ${sign}${formatter.format(trans.amount)}
                    </p>
                </div>
            `;
            return element;
        }

        // Рендер Моделей Бюджета
        function renderBudgetModels() {
            currentBudgetModel = budgetModelSelect.value;
            if (currentBudgetModel === 'none') {
                const msg = `<p class="text-gray-500 dark:text-gray-400" data-lang-key="settings.modelSelectPrompt">${t('settings.modelSelectPrompt')}</p>`;
                drawerModelDisplay.innerHTML = msg;
                mainModelDisplay.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400" data-lang-key="settings.modelSelectPromptShort">${t('settings.modelSelectPromptShort')}</p>`;
                return;
            }
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            let totalIncome = 0;
            const expensesByCategory = {
                'needs-503020': 0, 'wants-503020': 0, 'savings-503020': 0,
                'expenses-8020': 0, 'savings-8020': 0,
                'needs': 0, 'wants': 0, 'savings': 0, 'loan': 0, 'other': 0
            };
            allTransactions.forEach(t => {
                if (t.createdAt < monthStart) return;
                if (t.type === 'income') totalIncome += t.amount;
                else if (expensesByCategory.hasOwnProperty(t.category)) expensesByCategory[t.category] += t.amount;
                else expensesByCategory['other'] += t.amount;
            });
            let modelHtml = '';
            if (currentBudgetModel === '50-30-20') {
                const needsLimit = totalIncome * 0.5;
                const wantsLimit = totalIncome * 0.3;
                const savingsLimit = totalIncome * 0.2;
                const totalNeeds = (expensesByCategory['needs-503020'] || 0) + (expensesByCategory['needs'] || 0);
                const totalWants = (expensesByCategory['wants-503020'] || 0) + (expensesByCategory['wants'] || 0);
                const totalSavings = (expensesByCategory['savings-503020'] || 0) + (expensesByCategory['savings'] || 0);
                modelHtml = `
                    <h4 class="font-semibold text-gray-700 dark:text-gray-300">${t('budgetModel.income', {amount: formatter.format(totalIncome)})}</h4>
                    ${createProgressBar(t('budgetModel.needs'), totalNeeds, needsLimit)}
                    ${createProgressBar(t('budgetModel.wants'), totalWants, wantsLimit)}
                    ${createProgressBar(t('budgetModel.savings'), totalSavings, savingsLimit)}
                `;
            } else if (currentBudgetModel === '80-20') {
                const expensesLimit = totalIncome * 0.8;
                const savingsLimit = totalIncome * 0.2;
                const totalExpenses = (expensesByCategory['expenses-8020'] || 0) + (expensesByCategory['needs'] || 0) + (expensesByCategory['wants'] || 0) + (expensesByCategory['loan'] || 0) + (expensesByCategory['other'] || 0);
                const totalSavings = (expensesByCategory['savings-8020'] || 0) + (expensesByCategory['savings'] || 0);
                modelHtml = `
                    <h4 class="font-semibold text-gray-700 dark:text-gray-300">${t('budgetModel.income', {amount: formatter.format(totalIncome)})}</h4>
                    ${createProgressBar(t('budgetModel.expenses'), totalExpenses, expensesLimit)}
                    ${createProgressBar(t('budgetModel.savings_80'), totalSavings, savingsLimit)}
                `;
            }
            drawerModelDisplay.innerHTML = modelHtml;
            mainModelDisplay.innerHTML = modelHtml;
        }

        // Вспомогательная функция для прогресс-бара
        function createProgressBar(label, spent, limit) {
            const spentFormatted = formatter.format(spent);
            const limitFormatted = formatter.format(Math.max(0, limit));
            let percentage = (limit > 0) ? (spent / limit) * 100 : 0;
            let colorClass = 'bg-blue-600';
            if (percentage > 100) { percentage = 100; colorClass = 'bg-red-600'; }
            else if (percentage > 90) colorClass = 'bg-yellow-500';
            return `
                <div class="space-y-1">
                    <div class="flex justify-between text-sm font-medium">
                        <span class="text-gray-700 dark:text-gray-300">${label}</span>
                        <span class="text-gray-500 dark:text-gray-400">${spentFormatted} / ${limitFormatted}</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }
        
        // Рендер виджета Статуса Кредитов
        function renderLoanStatus() {
            const content = document.getElementById('loan-status-content');
            const icon = toggleLoanStatusBtn.querySelector('i');
            
            if (allLoans.length === 0) {
                loanStatusWidget.innerHTML = ''; // Очищаем все, включая заголовок
                return;
            }
            
            // Если виджет был пуст, восстанавливаем его структуру
            if (!loanStatusWidget.innerHTML) {
                 loanStatusWidget.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white" data-lang-key="loans.statusTitle">${t('loans.statusTitle')}</h3>
                        <button id="toggle-loan-status" class="text-blue-600 dark:text-blue-400 text-sm p-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div id="loan-status-content" class="space-y-3">
                    </div>`;
                // Снова находим элементы, т.к. мы их пересоздали
                document.getElementById('toggle-loan-status').addEventListener('click', toggleLoanStatusVisibility);
            }

            const statusContent = document.getElementById('loan-status-content');
            const statusIcon = document.querySelector('#toggle-loan-status i');
            statusContent.innerHTML = ''; // Очищаем только контент
            
            // Применяем сохраненное состояние видимости
            if (localStorage.getItem('loanStatusHidden') === 'true') {
                statusContent.classList.add('hidden');
                statusIcon.classList.remove('fa-eye');
                statusIcon.classList.add('fa-eye-slash');
            } else {
                statusContent.classList.remove('hidden');
                statusIcon.classList.remove('fa-eye-slash');
                statusIcon.classList.add('fa-eye');
            }

            const now = new Date();
            const today = now.getDate();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const loanPayments = allTransactions.filter(t => t.category === 'loan' && t.createdAt >= monthStart);
            allLoans.forEach(loan => {
                const paymentDate = loan.paymentDate;
                const hasPaid = loanPayments.some(p => p.loanId === loan.id);
                let statusText = '';
                let statusColor = 'text-gray-500 dark:text-gray-400';
                let statusIcon = 'fa-clock';
                if (hasPaid) { statusText = t('loanStatus.paid'); statusColor = 'text-green-600 dark:text-green-500'; statusIcon = 'fa-check-circle'; }
                else if (today > paymentDate) { statusText = t('loanStatus.overdue'); statusColor = 'text-red-600 dark:text-red-500'; statusIcon = 'fa-exclamation-circle'; }
                else if (paymentDate - today <= 5) { statusText = t('loanStatus.dueSoon', {days: paymentDate - today}); statusColor = 'text-yellow-600 dark:text-yellow-500'; statusIcon = 'fa-hourglass-half'; }
                else { statusText = t('loanStatus.due', {date: paymentDate}); }
                statusContent.innerHTML += `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-md flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-900 dark:text-white">${loan.name}</p>
                            <p class="text-sm ${statusColor} font-medium"><i class="fas ${statusIcon} mr-1"></i> ${statusText}</p>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-gray-900 dark:text-white">${formatter.format(loan.monthlyPayment)}</span>
                        </div>
                    </div>
                `;
            });
        }
        
        async function handleAccountSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const name = document.getElementById('account-name').value;
            const balance = parseFloat(document.getElementById('account-balance').value);
            const type = document.getElementById('account-type').value;
            const color = document.getElementById('account-color').value;
            const logoUrl = document.getElementById('account-logo-url').value;
            try {
                const newAccRef = push(ref(db, `users/${currentUserId}/accounts`));
                await set(newAccRef, { name, balance, type, color, logoUrl, createdAt: serverTimestamp(), order: allAccounts.length }); // <-- НОВОЕ: order
                toggleModal('account-modal', false);
                accountForm.reset();
                setupAccountModalUI();
                showToast(t('toast.accountAdded'));
            } catch (error) { console.error("Ошибка добавления счета:", error); showToast(t('toast.accountAddError'), true); }
        }
        
        // Добавление Кредита
        async function handleLoanSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return;
            try {
                const newLoanRef = push(ref(db, `users/${currentUserId}/loans`));
                await set(newLoanRef, {
                    name: document.getElementById('loan-name').value,
                    totalAmount: parseFloat(document.getElementById('loan-total-amount').value),
                    paidAmount: parseFloat(document.getElementById('loan-paid-amount').value),
                    monthlyPayment: parseFloat(document.getElementById('loan-monthly-payment').value),
                    paymentDate: parseInt(document.getElementById('loan-payment-date').value),
                    createdAt: serverTimestamp()
                });
                toggleModal('loan-modal', false);
                loanForm.reset();
                showToast('Кредит успешно добавлен!');
            } catch (error) { console.error("Ошибка добавления кредита:", error); showToast('Ошибка добавления кредита.', true); }
        }
        
        // Добавление Транзакции
        async function handleTransactionSubmit(e) {
            e.preventDefault();
            if (!currentUserId) return;
            const type = document.getElementById('transaction-type').value;
            const description = transactionDescriptionInput.value;
            const amount = parseFloat(transactionAmountInput.value);
            const accountId = transactionAccountSelect.value;
            const category = transactionCategory.value;
            const loanId = (category === 'loan') ? transactionLoanSelect.value : null;
            const isSavings = category === 'savings-503020' || category === 'savings-8020' || category === 'savings';
            const toAccountId = (isSavings) ? transactionSavingsSelect.value : null;
            
            if (!type || !description || isNaN(amount) || !accountId) { showToast(t('forms.fillAllFields'), true); return; }
            if (isSavings && !toAccountId) { showToast(t('forms.selectSavingsAccount'), true); return; }
            if (isSavings && toAccountId === accountId) { showToast(t('forms.noSameAccountTransfer'), true); return; }
            
            try {
                // 1. Добавляем транзакцию
                const newTransRef = push(ref(db, `users/${currentUserId}/transactions`));
                await set(newTransRef, { description, amount, type, accountId, category, createdAt: serverTimestamp(), loanId, toAccountId });
                
                // 2. Обновляем баланс счета (Откуда) с помощью транзакции RTDB
                const accountRef = ref(db, `users/${currentUserId}/accounts/${accountId}/balance`);
                const amountToUpdate = (type === 'income') ? amount : -amount;
                await runTransaction(accountRef, (currentBalance) => {
                    return (currentBalance || 0) + amountToUpdate;
                });
                
                // 3. Обновляем кредит (если это оплата)
                if (type === 'expense' && category === 'loan' && loanId) {
                    const loanRef = ref(db, `users/${currentUserId}/loans/${loanId}/paidAmount`);
                    await runTransaction(loanRef, (currentPaid) => {
                         return (currentPaid || 0) + amount;
                    });
                }
                
                // 4. Обновляем сберегательный счет (если это перевод)
                if (type === 'expense' && isSavings && toAccountId) {
                    const savingsAccountRef = ref(db, `users/${currentUserId}/accounts/${toAccountId}/balance`);
                    await runTransaction(savingsAccountRef, (currentBalance) => {
                        return (currentBalance || 0) + amount;
                    });
                }

                toggleModal('transaction-modal', false);
                transactionForm.reset();
                loanPaymentContainer.classList.add('hidden');
                savingsTransferContainer.classList.add('hidden');
                showToast(t('toast.transactionAdded', {type: isIncome ? t('toast.transactionType.income') : t('toast.transactionType.expense')}));
            } catch (error) { console.error("Ошибка добавления транзакции:", error); showToast(t('toast.transactionAddError'), true); }
        }
        
        // --- 6. Логика Удаления ---
        
        // --- ИЗМЕНЕНО: ЛОГИКА REALTIME DATABASE ---
        
        async function handleDeleteAccount(accountId) {
            if (!currentUserId) return;
            
            // 1. Проверяем, есть ли транзакции, связанные с этим счетом
            const transRef = ref(db, `users/${currentUserId}/transactions`);
            const transQueryFrom = dbQuery(transRef, orderByChild("accountId"), equalTo(accountId));
            const transQueryTo = dbQuery(transRef, orderByChild("toAccountId"), equalTo(accountId));
            
            try {
                // --- ИСПРАВЛЕНО: Используем get() вместо onValue() ---
                const [transSnapshotFrom, transSnapshotTo] = await Promise.all([
                    get(transQueryFrom),
                    get(transQueryTo)
                ]);
                
                 if (transSnapshotFrom.exists() || transSnapshotTo.exists()) {
                    // НЕЛЬЗЯ УДАЛЯТЬ
                    showToast(t('toast.deleteAccountError'), true);
                    return;
                }
                
                // 2. Если транзакций нет, удаляем счет
                const accountRef = ref(db, `users/${currentUserId}/accounts/${accountId}`);
                await remove(accountRef);
                
                showToast(t('toast.accountDeleted'));
                
            } catch (error) { console.error("Ошибка удаления счета:", error); showToast(`${t('toast.deleteAccountErrorGeneric')}: ${error}.`, true); }
        }
        
        async function handleDeleteLoan(loanId) {
            if (!currentUserId) return;
            
            // 1. Проверяем, есть ли транзакции (платежи), связанные с этим кредитом
             const transRef = ref(db, `users/${currentUserId}/transactions`);
             const transQuery = dbQuery(transRef, orderByChild("loanId"), equalTo(loanId));
            
            try {
                // --- ИСПРАВЛЕНО: Используем get() ---
                const transSnapshot = await get(transQuery);
                if (transSnapshot.exists()) {
                    // НЕЛЬЗЯ УДАЛЯТЬ
                    showToast(t('toast.deleteLoanError'), true);
                    return;
                }
                
                // 2. Если платежей нет, удаляем кредит
                const loanRef = ref(db, `users/${currentUserId}/loans/${loanId}`);
                await remove(loanRef);
                
                showToast(t('toast.loanDeleted'));
                
            } catch (error) { console.error("Ошибка удаления кредита:", error); showToast(t('toast.deleteLoanErrorGeneric'), true); }
        }
        
        // --- 7. Функции Auth (Вход/Регистрация/Выход) ---
        
        async function handleLogin(e) {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged сделает все остальное
            } catch (error) {
                console.error("Ошибка входа:", error.code);
                const errorKey = `auth.error.${error.code}`.replace(/[/.]/g, '-');
                const message = t(errorKey) || t('auth.error.default');
                authError.textContent = message;
                authError.dataset.lastErrorKey = errorKey;
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            authError.textContent = '';
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged сделает все остальное
            } catch (error) {
                console.error("Ошибка регистрации:", error.code);
                const errorKey = `auth.error.${error.code}`.replace(/[/.]/g, '-');
                const message = t(errorKey) || t('auth.error.default');
                authError.textContent = message;
                authError.dataset.lastErrorKey = errorKey;
            }
        }
        
        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged сделает все остальное
                toggleDrawer(false); // Закрываем drawer
            } catch (error) {
                console.error("Ошибка выхода:", error);
                showToast(t('toast.logoutError'), true);
            }
        }
        
        function getAuthErrorMessage(code) {
            // Эта функция больше не используется, т.к. ошибки обрабатываются в handleLogin/handleRegister с помощью t()
            // Оставим ее на всякий случай, но она не будет вызываться
            const errorKey = `auth.error.${code}`.replace(/[/.]/g, '-');
            return t(errorKey) || t('auth.error.default');
        }

        // --- 8. Вспомогательные функции для UI (без изменений) ---
        
        // Открытие модалки транзакции (Доход/Расход)
        function openTransactionModal(type) {
            const isIncome = (type === 'income');
            transactionModalTitle.textContent = isIncome ? t('forms.newIncome') : t('forms.newExpense');
            submitTransactionBtn.textContent = isIncome ? t('forms.addIncomeButton') : t('forms.addExpenseButton');
            submitTransactionBtn.className = `w-full text-white font-bold py-3 px-4 rounded-lg transition-all ${isIncome ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`;
            document.getElementById('transaction-type').value = type;
            document.getElementById('category-container').classList.toggle('hidden', isIncome);
            loanPaymentContainer.classList.add('hidden');
            savingsTransferContainer.classList.add('hidden');
            transactionAccountSelect.previousElementSibling.textContent = t('forms.account');
            if (!isIncome) populateCategories();
            transactionForm.reset();
            toggleModal('transaction-modal', true);
        }
        
        // Динамическое заполнение категорий
        function populateCategories() {
            transactionCategory.innerHTML = '';
            if (currentBudgetModel === '50-30-20') {
                transactionCategory.innerHTML = `
                    <option value="needs-503020">${t('categories.model.50-30-20.needs')}</option>
                    <option value="wants-503020">${t('categories.model.50-30-20.wants')}</option>
                    <option value="savings-503020">${t('categories.model.50-30-20.savings')}</option>
                    <option value="loan">${t('categories.loan')}</option>
                    <option value="other">${t('categories.other')}</option>
                `;
            } else if (currentBudgetModel === '80-20') {
                transactionCategory.innerHTML = `
                    <option value="expenses-8020">${t('categories.model.80-20.expenses')}</option>
                    <option value="savings-8020">${t('categories.model.80-20.savings')}</option>
                    <option value="loan">${t('categories.loan')}</option>
                    <option value="other">${t('categories.other')}</option>
                `;
            } else {
                 transactionCategory.innerHTML = `
                    <option value="needs">${t('categories.model.none.needs')}</option>
                    <option value="wants">${t('categories.model.none.wants')}</option>
                    <option value="savings">${t('categories.model.none.savings')}</option>
                    <option value="loan">${t('categories.loan')}</option>
                    <option value="other">${t('categories.other')}</option>
                `;
            }
            transactionCategory.dispatchEvent(new Event('change'));
        }
        
        function handleCategoryChange(e) {
            const category = e.target.value;
            loanPaymentContainer.classList.toggle('hidden', category !== 'loan');
            const isSavings = category === 'savings-503020' || category === 'savings-8020' || category === 'savings';
            savingsTransferContainer.classList.toggle('hidden', !isSavings);
            if (category === 'loan') {
                populateLoanSelect();
                transactionLoanSelect.onchange = handleLoanSelectChange;
            } else {
                transactionLoanSelect.onchange = null;
            }
            if (isSavings) {
                populateSavingsSelect();
                transactionSavingsSelect.onchange = handleSavingsSelectChange;
                transactionAccountSelect.previousElementSibling.textContent = t('forms.accountFrom');
            } else {
                transactionSavingsSelect.onchange = null;
                transactionAccountSelect.previousElementSibling.textContent = t('forms.account');
            }
            if (category !== 'loan') resetTransactionFormPartial();
        }

        
        // Настройка UI модалки Счета
        function setupAccountModalUI() {
            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', () => {
                    colorSwatches.forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                    accountColorInput.value = swatch.dataset.color;
                });
            });
            colorSwatches[0].click();
            accountTypeSelect.addEventListener('change', (e) => {
                bankLogoContainer.classList.toggle('hidden', e.target.value !== 'bank');
                if (e.target.value === 'cash') accountNameInput.value = t('accountTypes.cash');
                else if (e.target.value === 'savings' || e.target.value === 'deposit') accountNameInput.value = t('accountTypes.defaultSavings');
            });
            accountTypeSelect.dispatchEvent(new Event('change'));
            bankLogoInputs.forEach(logo => {
                logo.addEventListener('click', () => {
                    bankLogoInputs.forEach(l => l.classList.remove('selected'));
                    logo.classList.add('selected');
                    accountLogoUrlInput.value = logo.dataset.bankLogoUrl;
                    accountNameInput.value = logo.dataset.bankName;
                });
            });
            bankLogoInputs.forEach(l => l.classList.remove('selected'));
            accountLogoUrlInput.value = '';
        }
        
        // Заполнение <select> для счетов (Откуда)
        function populateAccountSelect() {
            transactionAccountSelect.innerHTML = '';
            if (allAccounts.length === 0) {
                transactionAccountSelect.innerHTML = `<option value="">${t('forms.noAccountFirst')}</option>`;
                return;
            }
            allAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (${formatter.format(acc.balance)})`;
                transactionAccountSelect.appendChild(option);
            });
        }
        
        // Заполнение <select> для кредитов
        function populateLoanSelect() {
            transactionLoanSelect.innerHTML = '';
            const unpaidLoans = allLoans.filter(l => l.paidAmount < l.totalAmount);
            if (unpaidLoans.length === 0) {
                transactionLoanSelect.innerHTML = `<option value="">${t('forms.noActiveLoans')}</option>`;
                return;
            }
            transactionLoanSelect.innerHTML = `<option value="">${t('forms.selectLoan')}</option>`;
            unpaidLoans.forEach(loan => {
                const option = document.createElement('option');
                option.value = loan.id;
                option.textContent = `${loan.name} (${formatter.format(loan.monthlyPayment)})`;
                transactionLoanSelect.appendChild(option);
            });
        }
        
        // Заполнение <select> для сбережений (Куда)
        function populateSavingsSelect() {
            transactionSavingsSelect.innerHTML = '';
            const savingsAccounts = allAccounts.filter(a => a.type === 'savings' || a.type === 'deposit');
            if (savingsAccounts.length === 0) {
                transactionSavingsSelect.innerHTML = `<option value="">${t('forms.noSavingsAccounts')}</option>`;
                return;
            }
            transactionSavingsSelect.innerHTML = `<option value="">${t('forms.selectAccount')}</option>`;
            savingsAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.name} (${formatter.format(acc.balance)})`;
                transactionSavingsSelect.appendChild(option);
            });
        }

        // Автозаполнение при выборе кредита
        function handleLoanSelectChange(e) {
            const selectedLoanId = e.target.value;
            if (!selectedLoanId) { resetTransactionFormPartial(); return; }
            const loan = allLoans.find(l => l.id === selectedLoanId);
            if (loan) {
                transactionDescriptionInput.value = `Оплата кредита - ${loan.name}`;
                transactionAmountInput.value = loan.monthlyPayment;
            }
        }
        
        // Автозаполнение при выборе сбережений
        function handleSavingsSelectChange(e) {
            const selectedAccountId = e.target.value;
            if (!selectedAccountId) { transactionDescriptionInput.value = ''; return; }
            const account = allAccounts.find(a => a.id === selectedAccountId);
            if(account) transactionDescriptionInput.value = `Перевод на "${account.name}"`;
        }
        
        // Частичный сброс формы
        function resetTransactionFormPartial() {
             transactionDescriptionInput.value = '';
             transactionAmountInput.value = '';
        }

        // --- НОВЫЕ ФУНКЦИИ: Drag-n-Drop (Touch Handlers) ---
        let touchStartX = 0;
        let touchStartY = 0;
        let scrollInterval = null; // Для авто-скролла
        let isDragging = false; // Флаг, что мы тащим, а не скроллим
        let isScrolling = false; // Флаг, что мы скроллим, а не тащим

        function handleTouchStart(e) {
            const targetCard = e.target.closest('.slider-item');
            if (!targetCard) return;
            
            draggedItem = targetCard;
            originalIndex = allAccounts.findIndex(acc => acc.id === draggedItem.dataset.accountId);
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isDragging = false;
            isScrolling = false;
        }
        
        function handleTouchMove(e) {
            if (!draggedItem || isScrolling) return;

            const touchCurrentX = e.touches[0].clientX;
            const touchCurrentY = e.touches[0].clientY;
            const deltaX = touchCurrentX - touchStartX;
            const deltaY = touchCurrentY - touchStartY;

            if (!isDragging) {
                // Мертвая зона: определяем, тащит пользователь или скроллит
                if (Math.abs(deltaX) > Math.abs(deltaY) + 5) { // Тащим горизонтально
                    isDragging = true;
                    draggedItem.classList.add('dragging'); 
                    accountsSlider.style.overflowX = 'hidden'; // Отключаем скролл слайдера
                } else if (Math.abs(deltaY) > Math.abs(deltaX) + 5) { // Скроллим вертикально
                    isScrolling = true;
                    draggedItem = null; // Отпускаем
                    return;
                }
            }
            
            if (isDragging) {
                e.preventDefault(); // Предотвращаем скролл страницы
                
                // Логика перемещения (такая же, как в handleDragOver)
                const afterElement = getDragAfterElement(accountsSlider, touchCurrentX);
                if (afterElement == null) {
                    accountsSlider.appendChild(draggedItem);
                } else {
                    accountsSlider.insertBefore(draggedItem, afterElement);
                }
                
                // Авто-скролл
                const sliderRect = accountsSlider.getBoundingClientRect();
                const edgeThreshold = 50; 
                if (touchCurrentX < sliderRect.left + edgeThreshold) {
                    startAutoScroll(-10); // Влево
                } else if (touchCurrentX > sliderRect.right - edgeThreshold) {
                    startAutoScroll(10); // Вправо
                } else {
                    stopAutoScroll();
                }
            }
        }
        
        function handleTouchEnd(e) {
            if (!draggedItem) return;
            
            stopAutoScroll();
            accountsSlider.style.overflowX = 'auto'; // Возвращаем скролл
            
            if (isDragging) {
                draggedItem.classList.remove('dragging');
                saveAccountOrder(); // Сохраняем
            }
            
            draggedItem = null;
            originalIndex = -1;
            isDragging = false;
            isScrolling = false;
        }
        
        // Вспомогательные функции для авто-скролла
        function startAutoScroll(step) {
            if (scrollInterval) return;
            scrollInterval = setInterval(() => {
                accountsSlider.scrollLeft += step;
            }, 30);
        }

        function stopAutoScroll() {
            clearInterval(scrollInterval);
            scrollInterval = null;
        }
        // --- КОНЕЦ НОВЫХ ФУНКЦИЙ ---


        // --- НОВЫЕ ФУНКЦИИ: Drag-n-Drop ---
        let draggedItem = null;
        let originalIndex = -1;

        function handleDragStart(e) {
            draggedItem = e.target.closest('.slider-item');
            if (!draggedItem) return;
            
            originalIndex = allAccounts.findIndex(acc => acc.id === draggedItem.dataset.accountId);
            
            // Даем браузеру время "схватить" элемент перед тем, как мы его стилизуем
            setTimeout(() => {
                if (draggedItem) draggedItem.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            const slider = accountsSlider;
            const afterElement = getDragAfterElement(slider, e.clientX);
            if (!draggedItem) return;

            if (afterElement == null) {
                slider.appendChild(draggedItem);
            } else {
                slider.insertBefore(draggedItem, afterElement);
            }
        }
        
        function handleDragLeave(e) {
            // (Не используется, но можно добавить для стилизации)
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedItem) return;
            
            draggedItem.classList.remove('dragging');
            
            // Получаем новый порядок из DOM
            const newOrderedIds = [...accountsSlider.querySelectorAll('.slider-item')].map(item => item.dataset.accountId);
            
            // Обновляем локальный массив allAccounts
            allAccounts.sort((a, b) => newOrderedIds.indexOf(a.id) - newOrderedIds.indexOf(b.id));

            // Сохраняем новый порядок в Firebase
            saveAccountOrder();
            
            draggedItem = null;
            originalIndex = -1;
        }
        
        function handleDragEnd(e) {
             if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
             // Если drop не сработал (напр., отпустили вне зоны), возвращаем в исходное состояние
            if (originalIndex !== -1) {
                renderAccounts(); // Просто перерисовываем
            }
            draggedItem = null;
            originalIndex = -1;
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.slider-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        async function saveAccountOrder() {
            if (!currentUserId) return;
            
            const updates = {};
            allAccounts.forEach((acc, index) => {
                updates[`users/${currentUserId}/accounts/${acc.id}/order`] = index;
            });
            
            try {
                await update(ref(db), updates);
                showToast(t('toast.orderSaved'));
            } catch (error) {
                console.error("Ошибка сохранения порядка:", error);
                showToast(t('toast.orderSaveError'), true);
                // Откатываем, если ошибка
                allAccounts.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderAccounts();
            }
        }

    </script>

</body>
</html>



